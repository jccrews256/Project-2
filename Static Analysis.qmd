---
title: "Initial Analysis of NFL Play-by-Play Data"
author: "Cass Crews"
format: html
editor: visual
---

# Loading Packages

```{r}
library(tidyverse)
library(lubridate)

options(scipen=999)
```


# Reading in Data

We need to read in the data and do some initial filtering; we will focus our analysis on only run and pass plays in the 2018-2019 season. 

```{r}
#Reading in data and filtering to passes and runs in the 2018-2019 season
play_data<-read_csv("NFL Play by Play 2009-2018 (v5).csv") |>
  filter(play_type %in% c("pass","run"),game_date >= ymd("2018-06-01"))
```
# Categorical Variable NUmeric Summaries

For this analysis, we will focus on 

As an initial step, let's explore the distribution between passes and runs.

```{r}
#Generating pass-run breakdown
play_data |>
  group_by(play_type) |>
  summarize(count=n()) |>
  ungroup() |>
  mutate(tot_plays=sum(count),proportion=count/tot_plays) |>
  select(!tot_plays)
```

Thus, 59.4% of plays in the 2018-2019 season were pass plays. 

Let's find out the breakdown between pass plays that resulted in a sack and pass plays that did not. 

```{r}
#Generating sack-not breakdown
play_data |>
  filter(play_type=="pass") |>
  group_by(sack) |>
  summarize(count=n()) |>
  mutate(tot_plays=sum(count),proportion=count/tot_plays) |>
  select(!tot_plays)
```

The data indicate 93% of pass plays resulted in a sack. 

Which type of play was more likely to result in a turnover? 

```{r}
#Generating turnover rates by play type
play_data |>
  #Identifying turnovers as lost fumbles and interceptions
  mutate(turnover=if_else(fumble_lost==1 | interception==1,"yes","no")) |>
  group_by(play_type,turnover) |>
  summarize(count=n()) |>
  ungroup() |>
  group_by(play_type) |>
  mutate(tot_plays=sum(count),proportion=count/tot_plays) |>
  select(!tot_plays)
```

It seems pass plays are much more likely to result in turnovers. 

How does the pass-run breakdown differ when a team is winning (or tied) and when it is losing? 

```{r}
#Generating pass-run breakdown for winning (or tied) and losing
play_data |>
  mutate(winning=if_else(score_differential>=0,"winning or tied","losing")) |>
  group_by(winning,play_type) |>
  summarize(count=n()) |>
  ungroup() |>
  group_by(winning) |>
  mutate(tot_plays=sum(count),proportion=count/tot_plays) |>
  select(!tot_plays)
```


Not surprisingly, teams are more likely to pass when they are losing than when they are winning. 


How does the run-pass breakdown vary across quarters? Note that the fifth quarter indicates overtime. 

```{r}
#Generating pass-run breakdown by quarter
play_data |>
  group_by(qtr,play_type) |>
  summarize(count=n()) |>
  ungroup() |>
  group_by(qtr) |>
  mutate(tot_plays=sum(count),proportion=count/tot_plays) |>
  select(!tot_plays)
```

Notably, passing plays are more common in quarters that end either the half or the game. This may indicate that coaches feel a greater sense of urgency near the end of the half/game. 


# Numeric Variable Numeric Summaries

Next, let's generate summary statistics for a few numeric variables in the dataset. In particular, let's calculate the mean, median, standard deviation, minimum, and maximum of yards gained during the play (`yards_gained`), score difference (offensive team score less defensive team score, `score_differential`), win probability for the offensive team (`wp`), expected points for the offensive team at the start of each play, expected points added by the play, and win probability added by the play. 

```{r}
play_data |>
  summarize(across(c(yards_gained,score_differential,wp,ep,epa,wpa),list(mean= ~mean(.x, na.rm = TRUE),
                                                                     median= ~median(.x, na.rm = TRUE),
                                                                     sd= ~sd(.x, na.rm = TRUE),
                                                                     IQR= ~IQR(.x, na.rm = TRUE),
                                                                     min= ~min(.x, na.rm = TRUE),
                                                                     max= ~max(.x, na.rm = TRUE)),.names="{.fn}__{.col}")) |>
  pivot_longer(everything(),names_to=c(".value","variable"),names_sep="__")
```

The game in which a single play increased the win probability by 0.94 must have had an exciting ending! I suspect the game ended on a successful Hail Mary. 

Let's explore these summary statistics by quarter to see how things like win probability added change as a game proceeds. 

```{r}
play_data |>
  group_by(qtr) |>
  summarize(across(c(yards_gained,score_differential,wp,ep,epa,wpa),list(mean= ~mean(.x, na.rm = TRUE),
                                                                     median= ~median(.x, na.rm = TRUE),
                                                                     sd= ~sd(.x, na.rm = TRUE),
                                                                     IQR= ~IQR(.x, na.rm = TRUE),
                                                                     min= ~min(.x, na.rm = TRUE),
                                                                     max= ~max(.x, na.rm = TRUE)),.names="{.fn}__{.col}")) |>
  pivot_longer(mean__yards_gained:max__wpa,names_to=c(".value","variable"),names_sep="__") |>
  arrange(variable,qtr)
```

I find two phenomena particularly notable: plays in the third quarter had the smallest average impact on win probability, and average yards gain was fairly stable across quarters. 

As a final step in our exploration of summary statistics, let's compare statistics across pass and run plays. 

```{r}
play_data |>
  group_by(play_type) |>
  summarize(across(c(yards_gained,score_differential,wp,ep,epa,wpa),list(mean= ~mean(.x, na.rm = TRUE),
                                                                     median= ~median(.x, na.rm = TRUE),
                                                                     sd= ~sd(.x, na.rm = TRUE),
                                                                     IQR= ~IQR(.x, na.rm = TRUE),
                                                                     min= ~min(.x, na.rm = TRUE),
                                                                     max= ~max(.x, na.rm = TRUE)),.names="{.fn}__{.col}")) |>
  pivot_longer(mean__yards_gained:max__wpa,names_to=c(".value","variable"),names_sep="__") |>
  arrange(variable,play_type)
```

The data effectively communicate how teams perceive passes and runs. Specifically, the average win probability added by a run play is roughly a third of the average added by a pass play, but the higher standard deviation in win probability added for pass plays reflects the greater uncertainty of these plays. 

# Graphical Summaries

