---
title: "Initial Analysis of NFL Play-by-Play Data"
author: "Cass Crews"
format: html
editor: visual
---

# Loading Packages

```{r}
library(tidyverse)
library(lubridate)
library(nflplotR)
library(plotly)

options(scipen=999)
```


# Reading in Data

We need to read in the data and do some initial filtering; we will focus our analysis on only run and pass plays in the 2018-2019 season. 

```{r}
#Reading in data and filtering to passes and runs in the 2018-2019 season
play_data<-read_csv("NFL Play by Play 2009-2018 (v5).csv") |>
  filter(play_type %in% c("pass","run"),game_date >= ymd("2018-06-01")) |>
  select(game_id,game_date,home_team,away_team,posteam,qtr,time,down,ydstogo,yrdln,total_home_score,total_away_score,score_differential,desc,play_type,yards_gained,wp,wpa,fumble_lost,interception)

play_data2<-read_csv("NFL Play by Play 2009-2018 (v5).csv") |>
  filter(game_date >= ymd("2018-06-01")) |>
  select(home_team,away_team,home_wp,away_wp,qtr,time,desc,wp,game_seconds_remaining,game_id)
```

```{r}
write_csv(play_data,"nfl_plays/2018_2019_rp_plays.csv")

write_csv(play_data2,"nfl_plays/2018_2019_all_plays.csv")
```

# Categorical Variable NUmeric Summaries

For this analysis, we will focus on 

As an initial step, let's explore the distribution between passes and runs.

```{r}
#Generating pass-run breakdown
play_data |>
  group_by(play_type) |>
  summarize(count=n()) |>
  ungroup() |>
  mutate(tot_plays=sum(count),proportion=count/tot_plays) |>
  select(!tot_plays)
```

Thus, 59.4% of plays in the 2018-2019 season were pass plays. 

Let's find out the breakdown between pass plays that resulted in a sack and pass plays that did not. 

```{r}
#Generating sack-not breakdown
play_data |>
  filter(play_type=="pass") |>
  group_by(sack) |>
  summarize(count=n()) |>
  mutate(tot_plays=sum(count),proportion=count/tot_plays) |>
  select(!tot_plays)
```

The data indicate 93% of pass plays resulted in a sack. 

Which type of play was more likely to result in a turnover? 

```{r}
#Generating turnover rates by play type
play_data |>
  #Identifying turnovers as lost fumbles and interceptions
  mutate(turnover=if_else(fumble_lost==1 | interception==1,"yes","no")) |>
  group_by(play_type,turnover) |>
  summarize(count=n()) |>
  ungroup() |>
  group_by(play_type) |>
  mutate(tot_plays=sum(count),proportion=count/tot_plays) |>
  select(!tot_plays)
```

It seems pass plays are much more likely to result in turnovers. 

How does the pass-run breakdown differ when a team is winning (or tied) and when it is losing? 

```{r}
#Generating pass-run breakdown for winning (or tied) and losing
play_data |>
  mutate(winning=if_else(score_differential>=0,"winning or tied","losing")) |>
  group_by(winning,play_type) |>
  summarize(count=n()) |>
  ungroup() |>
  group_by(winning) |>
  mutate(tot_plays=sum(count),proportion=count/tot_plays) |>
  select(!tot_plays)
```


Not surprisingly, teams are more likely to pass when they are losing than when they are winning. 


How does the run-pass breakdown vary across quarters? Note that the fifth quarter indicates overtime. 

```{r}
#Generating pass-run breakdown by quarter
play_data |>
  group_by(qtr,play_type) |>
  summarize(count=n()) |>
  ungroup() |>
  group_by(qtr) |>
  mutate(tot_plays=sum(count),proportion=count/tot_plays) |>
  select(!tot_plays)
```

Notably, passing plays are more common in quarters that end either the half or the game. This may indicate that coaches feel a greater sense of urgency near the end of the half/game. 


# Numeric Variable Numeric Summaries

Next, let's generate summary statistics for a few numeric variables in the dataset. In particular, let's calculate the mean, median, standard deviation, minimum, and maximum of yards gained during the play (`yards_gained`), score difference (offensive team score less defensive team score, `score_differential`), win probability for the offensive team (`wp`), expected points for the offensive team at the start of each play, expected points added by the play, and win probability added by the play. 

```{r}
play_data |>
  summarize(across(c(yards_gained,score_differential,wp,ep,epa,wpa),list(mean= ~mean(.x, na.rm = TRUE),
                                                                     median= ~median(.x, na.rm = TRUE),
                                                                     sd= ~sd(.x, na.rm = TRUE),
                                                                     IQR= ~IQR(.x, na.rm = TRUE),
                                                                     min= ~min(.x, na.rm = TRUE),
                                                                     max= ~max(.x, na.rm = TRUE)),.names="{.fn}__{.col}")) |>
  pivot_longer(everything(),names_to=c(".value","variable"),names_sep="__")
```

The game in which a single play increased the win probability by 0.94 must have had an exciting ending! I suspect the game ended on a successful Hail Mary. 

Let's explore these summary statistics by quarter to see how things like win probability added change as a game proceeds. 

```{r}
play_data |>
  group_by(qtr) |>
  summarize(across(c(yards_gained,score_differential,wp,ep,epa,wpa),list(mean= ~mean(.x, na.rm = TRUE),
                                                                     median= ~median(.x, na.rm = TRUE),
                                                                     sd= ~sd(.x, na.rm = TRUE),
                                                                     IQR= ~IQR(.x, na.rm = TRUE),
                                                                     min= ~min(.x, na.rm = TRUE),
                                                                     max= ~max(.x, na.rm = TRUE)),.names="{.fn}__{.col}")) |>
  pivot_longer(mean__yards_gained:max__wpa,names_to=c(".value","variable"),names_sep="__") |>
  arrange(variable,qtr)
```

I find two phenomena particularly notable: plays in the third quarter had the smallest average impact on win probability, and average yards gain was fairly stable across quarters. 

As a final step in our exploration of summary statistics, let's compare statistics across pass and run plays. 

```{r}
play_data |>
  group_by(play_type) |>
  summarize(across(c(yards_gained,score_differential,wp,ep,epa,wpa),list(mean= ~mean(.x, na.rm = TRUE),
                                                                     median= ~median(.x, na.rm = TRUE),
                                                                     sd= ~sd(.x, na.rm = TRUE),
                                                                     IQR= ~IQR(.x, na.rm = TRUE),
                                                                     min= ~min(.x, na.rm = TRUE),
                                                                     max= ~max(.x, na.rm = TRUE)),.names="{.fn}__{.col}")) |>
  pivot_longer(mean__yards_gained:max__wpa,names_to=c(".value","variable"),names_sep="__") |>
  arrange(variable,play_type)
```

The data effectively communicate how teams perceive passes and runs. Specifically, the average win probability added by a run play is roughly a third of the average added by a pass play, but the higher standard deviation in win probability added for pass plays reflects the greater uncertainty of these plays. 

# Graphical Summaries

To begin our visual analysis, let's plot a kernel density of yards gained. 

```{r}
#Plotting distribution of yards gained per play
ggplot(data=play_data,aes(x=yards_gained))+geom_density(alpha=0.5,fill="navy")+labs(title="Distribution of Yards Gained per Play",x="Yards Gained",y="Density")
```

Note the peak at no gain. This likely reflected the common outcome of an incompletion. Let's plot separate kernel densities for each play type (pass and run) to see if we are correct. 

```{r}
ggplot(data=play_data,aes(x=yards_gained,fill=play_type))+geom_density(alpha=0.5)+labs(title="Distribution of Yards Gained by Play Type",x="Yards Gained",y="Density",fill="Play Type")
```

When we approximate density functions for each play type, we not only see the high likelihood of an incompletion but also two additional pass-specific modes reflecting sacks and completions. 

Next, we will explore the relationship between yards gained and win probability added via a scatterplot, with point colors varying by quarter. 

```{r}
ggplot(data=play_data,aes(x=yards_gained,y=wpa))+geom_point(alpha=0.5,color="navy")+
  labs(title="Scatterplot of Yards Gained vs. Win Probability Added",x="Yards Gained",y="Win Probability Added")
```


Note the positive trend, with most yard-losing plays having a negative impact on win probability and win probability being increasingly positive, on average, as yardage increases. However, there is a lot of variability in win probability added given the yards gained, reflecting differences in the game situation across plays. 

A key artefact of the data: the large number of no-gain plays with major negative win probability impacts is due to the fact that all interceptions are assigned a yardage of 0. 

I suspect the majority of majorly impactful plays occurred in the fourth quarter, so let's generate the same plot for the fourth quarter only. 

```{r}
ggplot(data=play_data |> filter(qtr==4),aes(x=yards_gained,y=wpa))+geom_point(alpha=0.5,color="navy")+
  labs(title="Scatterplot of Yards Gained vs. Win Probability Added in the Fourth Quarter",x="Yards Gained",y="Win Probability Added")
```


It seems my hypothesis is correct, as most plays with a win probability impact above 0.5 in absolute value are also present in this plot. 

Let's next explore the balance between run and pass plays for each team. 

```{r, fig.width=8, fig.height=20}
ggplot(data=play_data,aes(x=play_type,fill=play_type))+geom_bar()+facet_wrap(vars(posteam),ncol=4)+
  theme_minimal()+
  theme(
    plot.title.position = "plot",
    plot.title = ggplot2::element_text(face = "bold"),
    axis.title = element_blank(),
    plot.background = ggplot2::element_rect(fill = "#F0F0F0"),
    # make wordmarks of team abbreviations
    strip.text = nflplotR::element_nfl_wordmark(size = 1),
    # load image from url in caption
    plot.caption = ggpath::element_path(hjust = 1, size = 0.4)
  )+labs(title="Run-Pass Breakdown for Each Team",fill=NULL)
```

It seems the Titans had the most balanced offense in the 2018-2019 season, while the Seahawks were the only team to run more than pass. 

For the final plot, let's visualize each team's win probability across a single game. In particular, let's plot the Eagles win probability across the game in their Week 1 match-up with the Falcons. 

```{r}
play_data_1game<-play_data2 |>
  filter(game_id == 2018090600) |>
  drop_na(wp) |>
  mutate(play_time=(3600-game_seconds_remaining)/60,dummy=1) |>
  mutate(play_num=cumsum(dummy)) |>
  select(home_team,away_team,home_wp,away_wp,play_time,play_num,qtr,time,desc) |>
  mutate(tooltip=paste0("Quarter: ", qtr, 
                              "<br>Game Clock: ", time,
                              "<br>Play: ", desc, 
                              "<br>", home_team, " Win Probability: ", round(home_wp,3),
                        "<br>",away_team," Win Probability: ", round(away_wp,3)))

g<-ggplot(data=play_data_1game,aes(x=play_num,y=home_wp,color=home_team))+geom_line(linewidth=1.5)+scale_color_nfl(type = "primary") + 
  coord_cartesian(ylim=c(0,1))+
  geom_point(aes(text = tooltip), alpha = 0, size = 0.01, show.legend = FALSE)+
  labs(title="Win Probability for the Eagles in their Week 1 Game Against the Falcons",x="Play Number",y="Win Probability")

ggplotly(g,tooltip="text")
```





It seems this was a back-and-forth game until the Eagles took the lead for the final time in the fourth quarter. 